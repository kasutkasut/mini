import{g as W,b as N,r as p,u as V,_,d as f,j as t,e as G,a as O,B as a,m as lt,o as ct}from"./index-CLvkM5_n.js";import{C as pt,g as dt}from"./characters-CTF1Z5aN.js";import{u as M}from"./userStore-DtecM2vn.js";import{B as $}from"./Button-DGmbhBTc.js";import{A as q,I as z}from"./ArrowBack-PD1JCqK2.js";import{e as J,f as K,P as R,c as k,T as g,C as H}from"./Container-CqMN9KuF.js";import{C as Y}from"./Chip--yBZ1UkB.js";import{g as U}from"./Menu-BWqLNsRe.js";import{A as D}from"./Avatar-Bhh-X8wS.js";import{T as xt}from"./TextField-CEYTek79.js";function ut(o){return W("MuiAppBar",o)}N("MuiAppBar",["root","positionFixed","positionAbsolute","positionSticky","positionStatic","positionRelative","colorDefault","colorPrimary","colorSecondary","colorInherit","colorTransparent","colorError","colorInfo","colorSuccess","colorWarning"]);const gt=["className","color","enableColorOnDark","position"],ht=o=>{const{color:s,position:i,classes:n}=o,c={root:["root",`color${O(s)}`,`position${O(i)}`]};return K(c,ut,n)},E=(o,s)=>o?`${o==null?void 0:o.replace(")","")}, ${s})`:s,bt=J(R,{name:"MuiAppBar",slot:"Root",overridesResolver:(o,s)=>{const{ownerState:i}=o;return[s.root,s[`position${O(i.position)}`],s[`color${O(i.color)}`]]}})(({theme:o,ownerState:s})=>{const i=o.palette.mode==="light"?o.palette.grey[100]:o.palette.grey[900];return f({display:"flex",flexDirection:"column",width:"100%",boxSizing:"border-box",flexShrink:0},s.position==="fixed"&&{position:"fixed",zIndex:(o.vars||o).zIndex.appBar,top:0,left:"auto",right:0,"@media print":{position:"absolute"}},s.position==="absolute"&&{position:"absolute",zIndex:(o.vars||o).zIndex.appBar,top:0,left:"auto",right:0},s.position==="sticky"&&{position:"sticky",zIndex:(o.vars||o).zIndex.appBar,top:0,left:"auto",right:0},s.position==="static"&&{position:"static"},s.position==="relative"&&{position:"relative"},!o.vars&&f({},s.color==="default"&&{backgroundColor:i,color:o.palette.getContrastText(i)},s.color&&s.color!=="default"&&s.color!=="inherit"&&s.color!=="transparent"&&{backgroundColor:o.palette[s.color].main,color:o.palette[s.color].contrastText},s.color==="inherit"&&{color:"inherit"},o.palette.mode==="dark"&&!s.enableColorOnDark&&{backgroundColor:null,color:null},s.color==="transparent"&&f({backgroundColor:"transparent",color:"inherit"},o.palette.mode==="dark"&&{backgroundImage:"none"})),o.vars&&f({},s.color==="default"&&{"--AppBar-background":s.enableColorOnDark?o.vars.palette.AppBar.defaultBg:E(o.vars.palette.AppBar.darkBg,o.vars.palette.AppBar.defaultBg),"--AppBar-color":s.enableColorOnDark?o.vars.palette.text.primary:E(o.vars.palette.AppBar.darkColor,o.vars.palette.text.primary)},s.color&&!s.color.match(/^(default|inherit|transparent)$/)&&{"--AppBar-background":s.enableColorOnDark?o.vars.palette[s.color].main:E(o.vars.palette.AppBar.darkBg,o.vars.palette[s.color].main),"--AppBar-color":s.enableColorOnDark?o.vars.palette[s.color].contrastText:E(o.vars.palette.AppBar.darkColor,o.vars.palette[s.color].contrastText)},!["inherit","transparent"].includes(s.color)&&{backgroundColor:"var(--AppBar-background)"},{color:s.color==="inherit"?"inherit":"var(--AppBar-color)"},s.color==="transparent"&&{backgroundImage:"none",backgroundColor:"transparent",color:"inherit"}))}),ft=p.forwardRef(function(s,i){const n=V({props:s,name:"MuiAppBar"}),{className:c,color:m="primary",enableColorOnDark:d=!1,position:u="fixed"}=n,y=_(n,gt),h=f({},n,{color:m,position:u,enableColorOnDark:d}),v=ht(h);return t.jsx(bt,f({square:!0,component:"header",ownerState:h,elevation:4,className:G(v.root,c,u==="fixed"&&"mui-fixed"),ref:i},y))});function mt(o){return W("MuiToolbar",o)}N("MuiToolbar",["root","gutters","regular","dense"]);const yt=["className","component","disableGutters","variant"],vt=o=>{const{classes:s,disableGutters:i,variant:n}=o;return K({root:["root",!i&&"gutters",n]},mt,s)},jt=J("div",{name:"MuiToolbar",slot:"Root",overridesResolver:(o,s)=>{const{ownerState:i}=o;return[s.root,!i.disableGutters&&s.gutters,s[i.variant]]}})(({theme:o,ownerState:s})=>f({position:"relative",display:"flex",alignItems:"center"},!s.disableGutters&&{paddingLeft:o.spacing(2),paddingRight:o.spacing(2),[o.breakpoints.up("sm")]:{paddingLeft:o.spacing(3),paddingRight:o.spacing(3)}},s.variant==="dense"&&{minHeight:48}),({theme:o,ownerState:s})=>s.variant==="regular"&&o.mixins.toolbar),Ct=p.forwardRef(function(s,i){const n=V({props:s,name:"MuiToolbar"}),{className:c,component:m="div",disableGutters:d=!1,variant:u="regular"}=n,y=_(n,yt),h=f({},n,{component:m,disableGutters:d,variant:u}),v=vt(h);return t.jsx(jt,f({as:m,className:G(v.root,c),ref:i,ownerState:h},y))}),St=k(t.jsx("path",{d:"m12 21.35-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54z"}),"Favorite"),kt=k(t.jsx("path",{d:"M16.5 3c-1.74 0-3.41.81-4.5 2.09C10.91 3.81 9.24 3 7.5 3 4.42 3 2 5.42 2 8.5c0 3.78 3.4 6.86 8.55 11.54L12 21.35l1.45-1.32C18.6 15.36 22 12.28 22 8.5 22 5.42 19.58 3 16.5 3m-4.4 15.55-.1.1-.1-.1C7.14 14.24 4 11.39 4 8.5 4 6.5 5.5 5 7.5 5c1.54 0 3.04.99 3.57 2.36h1.87C13.46 5.99 14.96 5 16.5 5c2 0 3.5 1.5 3.5 3.5 0 2.89-3.14 5.74-7.9 10.05"}),"FavoriteBorder"),It=k(t.jsx("path",{d:"M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2m-2 12H6v-2h12zm0-3H6V9h12zm0-3H6V6h12z"}),"Message"),At=k(t.jsx("path",{d:"M2.01 21 23 12 2.01 3 2 10l15 2-15 2z"}),"Send"),Bt=k(t.jsx("path",{d:"M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"}),"Star"),Tt=k(t.jsx("path",{d:"m22 9.24-7.19-.62L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27 18.18 21l-1.63-7.03zM12 15.4l-3.76 2.27 1-4.28-3.32-2.88 4.38-.38L12 6.1l1.71 4.04 4.38.38-3.32 2.88 1 4.28z"}),"StarBorder"),Rt=({character:o,onStartChat:s,onBack:i})=>{var v;const{characterStats:n,toggleLike:c,toggleFavorite:m}=M(),d=n[o.id]||{likes:0,favorites:0,isLiked:!1,isFavorited:!1},u=M(b=>b.user),y=async b=>{if(b.stopPropagation(),!u||!u.id){console.error("User not authenticated");return}c(o.id);try{const j=await fetch(`/api/characters/${o.id}/like`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:u.id,isLiked:!d.isLiked})});if(!j.ok)throw new Error("Failed to update like status");const L=await j.json();if(L.success)M.setState(I=>({characterStats:{...I.characterStats,[o.id]:{...I.characterStats[o.id],likes:L.likes}}}));else throw new Error("Failed to update like count")}catch(j){console.error("Error updating like status:",j),c(o.id)}},h=b=>{b.stopPropagation(),m(o.id)};return t.jsxs(a,{sx:{minHeight:"100vh",bgcolor:"#1A1B1E",color:"white"},children:[t.jsx(a,{sx:{display:"flex",alignItems:"center",p:2,borderBottom:"1px solid rgba(255, 255, 255, 0.1)"},children:t.jsx($,{startIcon:t.jsx(q,{}),onClick:i,sx:{color:"rgba(255, 255, 255, 0.7)","&:hover":{color:"white",bgcolor:"rgba(255, 255, 255, 0.1)"}},children:"Back"})}),t.jsxs(a,{sx:{p:0},children:[t.jsx(a,{sx:{width:"100%",height:"70vh",position:"relative"},children:t.jsx(a,{component:"img",src:o.avatar,alt:o.name,sx:{width:"100%",height:"100%",objectFit:"cover"}})}),t.jsxs(a,{sx:{p:2},children:[t.jsxs(a,{sx:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",mb:2},children:[t.jsxs(a,{children:[t.jsx(g,{variant:"h6",sx:{fontWeight:"bold",mb:1},children:o.name}),t.jsxs(g,{variant:"caption",sx:{color:"rgba(255, 255, 255, 0.7)"},children:["Author: ",o.author]})]}),t.jsxs(a,{sx:{display:"flex",alignItems:"center",gap:3},children:[t.jsxs(a,{sx:{display:"flex",flexDirection:"column",alignItems:"center"},children:[t.jsx(z,{onClick:y,sx:{color:d.isLiked?"#ff4081":"rgba(255, 255, 255, 0.7)",p:1},children:d.isLiked?t.jsx(St,{}):t.jsx(kt,{})}),t.jsx(g,{variant:"caption",sx:{color:"rgba(255, 255, 255, 0.7)",minHeight:"16px"},children:d.likes})]}),t.jsxs(a,{sx:{display:"flex",flexDirection:"column",alignItems:"center"},children:[t.jsx(z,{onClick:h,sx:{color:d.isFavorited?"#ffd700":"rgba(255, 255, 255, 0.7)",p:1},children:d.isFavorited?t.jsx(Bt,{}):t.jsx(Tt,{})}),t.jsx(g,{variant:"caption",sx:{color:"rgba(255, 255, 255, 0.7)",minHeight:"16px"},children:d.favorites})]})]})]}),t.jsx(a,{sx:{display:"flex",flexWrap:"wrap",gap:1,mb:2},children:(v=o.tags)==null?void 0:v.map((b,j)=>t.jsx(Y,{label:b,size:"small",sx:{bgcolor:"rgba(255, 255, 255, 0.1)",color:"rgba(255, 255, 255, 0.9)",borderRadius:"4px",height:"24px",maxWidth:"150px","& .MuiChip-label":{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}},j))}),t.jsx(g,{variant:"body2",sx:{color:"rgba(255, 255, 255, 0.9)",mb:3},children:o.description}),t.jsx($,{fullWidth:!0,variant:"contained",size:"large",startIcon:t.jsx(It,{}),onClick:s,sx:{bgcolor:"#7C3AED",borderRadius:2,py:1.5,textTransform:"none","&:hover":{bgcolor:"#6D28D9"}},children:"Start a private chat"})]})]})]})},Ht=()=>{const o=lt(),{characterId:s}=ct(),[i,n]=p.useState([]),[c,m]=p.useState(""),[d,u]=p.useState(!0),[y,h]=p.useState(!1),[v,b]=p.useState(""),[j,L]=p.useState(!1),I=p.useRef(null),X=p.useRef(null),Z=p.useRef(null),{addChatMessage:P,getChatHistory:Q}=M(),r=pt[s],tt=()=>{var e;(e=I.current)==null||e.scrollIntoView({behavior:"smooth"})};p.useEffect(()=>{if(!r){o("/");return}},[r,o]),p.useEffect(()=>{tt()},[i]),p.useEffect(()=>{const e=Q(s);e.length>0&&n(e)},[s]);const ot=async e=>{try{const l=await dt(e);return l?(b(l.mainScenario),l):null}catch(l){return console.error("Error generating scenario:",l),null}},et=async(e,l,{previousMessages:x})=>{let C=0;for(;C<3;)try{const B=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer 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"},body:JSON.stringify({model:"gpt-3.5-turbo",messages:[{role:"system",content:`You are ${e.name}. ${JSON.stringify(e.characterSettings)}`},...x.map(S=>({role:S.role,content:S.text})),{role:"user",content:l}],temperature:.7,max_tokens:1e3})});if(!B.ok)throw new Error(`OpenAI API error: ${B.status}`);const T=await B.json();if(!T.choices||!T.choices[0])throw new Error("Invalid response from OpenAI API");const w=T.choices[0].message.content;try{const S=await fetch("https://api.elevenlabs.io/v1/text-to-speech/undefined",{method:"POST",headers:{"Content-Type":"application/json","xi-api-key":"sk_0c986593df12aa6b2fa1f89caf99f795cafb7593255b08ab"},body:JSON.stringify({text:w,voice_settings:{stability:.5,similarity_boost:.5}})});if(!S.ok)return console.warn("Voice generation failed, continuing without audio"),{response:{text:w,status:e.storySettings.initialContext.mood,location:e.storySettings.initialContext.location,mood:e.emotionalSettings.baseEmotions[0],action:e.storySettings.initialContext.currentSituation}};const nt=await S.blob(),at=URL.createObjectURL(nt);return{response:{text:w,status:e.storySettings.initialContext.mood,location:e.storySettings.initialContext.location,mood:e.emotionalSettings.baseEmotions[0],action:e.storySettings.initialContext.currentSituation},audioUrl:at}}catch(S){return console.error("Error generating voice:",S),{response:{text:w,status:e.storySettings.initialContext.mood,location:e.storySettings.initialContext.location,mood:e.emotionalSettings.baseEmotions[0],action:e.storySettings.initialContext.currentSituation}}}}catch(B){if(console.error(`Attempt ${C+1} failed:`,B),C++,C===3)return console.error("All retry attempts failed"),{response:{text:e.dialogueSettings.responseTemplates.thinking,status:e.storySettings.initialContext.mood,location:e.storySettings.initialContext.location,mood:e.emotionalSettings.baseEmotions[0],action:e.storySettings.initialContext.currentSituation}};await new Promise(T=>setTimeout(T,1e3*C))}},F=async e=>{const l={role:"user",text:e,timestamp:new Date().toISOString()};n(x=>[...x,l]),P(s,l);try{const A={role:"assistant",...await et(r,e,{previousMessages:i}),timestamp:new Date().toISOString()};n(C=>[...C,A]),P(s,A)}catch(x){console.error("Error generating response:",x)}},st=async()=>{u(!1),h(!0);try{const e=await ot(r);if(e){const l={text:e.mainScenario,type:"scenario",timestamp:new Date().toISOString(),context:e.initialContext,topics:e.possibleTopics},x={text:r.dialogueSettings.responseTemplates.greeting,type:"character",timestamp:new Date().toISOString(),status:e.initialContext.mood,location:e.initialContext.location,mood:r.emotionalSettings.baseEmotions[0],action:e.initialContext.situation};n([l,x])}else{const l={text:r.storySettings.mainScenario,type:"scenario",timestamp:new Date().toISOString(),context:r.storySettings.initialContext,topics:r.storySettings.plotPoints},x={text:r.dialogueSettings.responseTemplates.greeting,type:"character",timestamp:new Date().toISOString(),status:r.storySettings.initialContext.mood,location:r.storySettings.initialContext.location,mood:r.emotionalSettings.baseEmotions[0],action:r.storySettings.initialContext.currentSituation};n([l,x])}}catch(e){console.error("Error starting chat:",e);const l={text:r.dialogueSettings.responseTemplates.greeting,type:"character",timestamp:new Date().toISOString()};n([l])}finally{h(!1)}},it=()=>{o("/")},rt=e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),F(c))};return r?d?t.jsx(U,{in:!0,children:t.jsx("div",{children:t.jsx(Rt,{character:r,onStartChat:st,onBack:it})})}):t.jsxs(a,{sx:{height:"100vh",display:"flex",flexDirection:"column",bgcolor:"#1A1B1E"},children:[t.jsx(ft,{position:"static",elevation:0,sx:{bgcolor:"rgba(26, 27, 30, 0.8)",borderBottom:"1px solid rgba(255, 255, 255, 0.1)"},children:t.jsxs(Ct,{children:[t.jsx(z,{edge:"start",color:"inherit",onClick:()=>u(!0),children:t.jsx(q,{})}),t.jsx(D,{src:r.avatar,sx:{width:40,height:40,mx:2}}),t.jsx(g,{variant:"h6",component:"div",sx:{flexGrow:1,color:"white"},children:r.name})]})}),t.jsxs(H,{maxWidth:"md",sx:{flex:1,overflow:"auto",py:2,display:"flex",flexDirection:"column",gap:2},children:[i.map((e,l)=>t.jsx(U,{in:!0,children:t.jsxs(a,{sx:{display:"flex",justifyContent:e.role==="user"?"flex-end":"flex-start",gap:2,width:"100%"},children:[e.role==="assistant"&&t.jsx(D,{src:r.avatar,sx:{width:40,height:40}}),t.jsxs(a,{sx:{maxWidth:e.type==="scenario"?"100%":"70%"},children:[e.type==="scenario"&&t.jsxs(R,{elevation:0,sx:{p:3,bgcolor:"rgba(0, 0, 0, 0.3)",color:"white",borderRadius:2,mb:2},children:[t.jsx(g,{variant:"subtitle1",sx:{color:"#7C3AED",mb:1,fontWeight:500},children:"Initial Scenario:"}),t.jsx(g,{variant:"body1",children:e.text}),e.context&&t.jsxs(a,{sx:{mt:2,p:1,bgcolor:"rgba(0, 0, 0, 0.3)",borderRadius:1,fontSize:"0.875rem",color:"rgba(255, 255, 255, 0.7)"},children:[e.context.location&&t.jsxs("div",{children:["Location: ",e.context.location]}),e.context.mood&&t.jsxs("div",{children:["Mood: ",e.context.mood]}),e.context.situation&&t.jsxs("div",{children:["Situation: ",e.context.situation]})]}),e.topics&&e.topics.length>0&&t.jsxs(a,{sx:{mt:2},children:[t.jsx(g,{variant:"subtitle2",sx:{color:"#7C3AED",mb:1},children:"Suggested Topics:"}),t.jsx(a,{sx:{display:"flex",flexWrap:"wrap",gap:1},children:e.topics.map((x,A)=>t.jsx(Y,{label:x,size:"small",sx:{bgcolor:"rgba(124, 58, 237, 0.2)",color:"white","&:hover":{bgcolor:"rgba(124, 58, 237, 0.3)"}}},A))})]})]}),e.role!=="user"&&t.jsx(R,{elevation:1,sx:{p:2,bgcolor:e.role==="user"?"#7C3AED":"rgba(255, 255, 255, 0.05)",color:"white",borderRadius:e.role==="user"?"20px 20px 0 20px":"20px 20px 20px 0"},children:t.jsx(g,{variant:"body1",children:e.text})})]}),e.role==="user"&&t.jsx(D,{sx:{bgcolor:"#7C3AED",width:40,height:40},children:"You"})]})},l)),y&&t.jsxs(a,{sx:{display:"flex",gap:2,alignItems:"center"},children:[t.jsx(D,{src:r.avatar,sx:{width:40,height:40}}),t.jsx(R,{elevation:1,sx:{p:2,maxWidth:"70%",bgcolor:"rgba(255, 255, 255, 0.05)",color:"white",borderRadius:"20px 20px 20px 0"},children:t.jsx(g,{variant:"body1",children:"Typing..."})})]}),t.jsx("div",{ref:I})]}),t.jsx(R,{elevation:0,sx:{p:2,bgcolor:"rgba(26, 27, 30, 0.8)",borderTop:"1px solid rgba(255, 255, 255, 0.1)"},children:t.jsx(H,{maxWidth:"md",children:t.jsxs(a,{sx:{display:"flex",gap:2},children:[t.jsx(xt,{fullWidth:!0,multiline:!0,maxRows:4,value:c,onChange:e=>m(e.target.value),onKeyPress:rt,placeholder:"Type your message...",variant:"outlined",size:"small",inputRef:X,sx:{"& .MuiOutlinedInput-root":{bgcolor:"rgba(255, 255, 255, 0.05)",borderRadius:3,color:"white","& fieldset":{borderColor:"rgba(255, 255, 255, 0.1)"},"&:hover fieldset":{borderColor:"rgba(255, 255, 255, 0.2)"},"&.Mui-focused fieldset":{borderColor:"#7C3AED"}},"& .MuiOutlinedInput-input::placeholder":{color:"rgba(255, 255, 255, 0.5)"}}}),t.jsx(z,{onClick:()=>F(c),disabled:!c.trim()||y,sx:{bgcolor:"#7C3AED",color:"white","&:hover":{bgcolor:"#6D28D9"},"&.Mui-disabled":{bgcolor:"rgba(124, 58, 237, 0.2)",color:"rgba(255, 255, 255, 0.3)"}},children:t.jsx(At,{})})]})})}),t.jsx("audio",{ref:Z,style:{display:"none"}})]}):null};export{Ht as default};
//# sourceMappingURL=Chat-DsWGOr5L.js.map
